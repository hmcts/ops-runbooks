<h1 id="manually-generated-certificates">Manually Generated Certificates</h1>
<p>This article describes the process for issuing or renewing an SSL certificate that is not suitable for our automated certificates in the other guides of this chapter.</p>
<h2 id="prerequisites">Prerequisites</h2>

<ul>
<li>A local version of the <a href="https://github.com/hmcts/rdo-ssl-creation/tree/openssl-mac-branch">rdo-ssl-creation repo</a></li>
<li>A local version of the <a href="https://github.com/hmcts/azure-public-dns">azure-public-dns repo</a></li>
<li>A certificate in need of renewal (either a notification from Ops or a Jira ticket)</li>
</ul>
<p>We have a certificate tracker which is populated a month in advance by the Operations team with certs that are expiring soon, view it on <a href="https://cjscommonplatform-my.sharepoint.com/:x:/r/personal/zoe_cope_hmcts_net/_layouts/15/Doc.aspx?sourcedoc=%7B6C8A9500-4D9D-45EA-8CC7-D75F3DDFF133%7D&amp;file=Cert%20Tracker.xlsx&amp;action=default&amp;mobileredirect=true">sharepoint</a>, you may need to request access.</p>
<h2 id="step-by-step-guide">Step-by-step guide:</h2>
<p>There are 3 key stages to the renewal process:</p>

<ul>
<li><a href="#Step-1:-Generate-the-CSR-and-request-form">Generate the CSR and request form</a></li>
<li><a href="#Step-2:-Point-the-DNS">Point the DNS</a></li>
<li><a href="#Step-3:-Upload-the-certificate-to-Azure">Upload the certificate to Azure</a></li>
</ul>
<h4 id="note">Note:</h4>
<p>If someone has requested for a new SSL certificate to be ordered, you should check if Azure has delegation of the domain (assuming it is being hosted in Azure). 
You can do this by going on https://mxtoolbox.com/ and running a DNS Check.
If there are no results, you should contact the requester and get them to create the domain and DNS zone.
DNS zones are created in https://github.com/hmcts/azure-public-dns.</p>
<p>From there, they need to have the NS records at hand to pass over to whoever does the delegation.
For hmcts.net domains, contact the Operations team for delegation.
For service.gov.uk domains, you need to contact Government Digital Service (GDS) - you can speak to Cairbre Smith to assist with that.</p>
<h3 id="step-1-generate-the-csr-and-request-form">Step 1: Generate the CSR and request form</h3>
<p>This section is described in detail on the <a href="csr.md">Requesting SSL Certificates</a> guide.</p>
<p>Once the CSR and form has been generated, they are sent via email to Ops Config Management (opsconfman@hmcts.net).</p>
<h3 id="step-2-point-the-dns">Step 2: Point the DNS</h3>
<p>Ops then return the validation instructions for pointing the DNS, for example:</p>

<blockquote>
<p>&ldquo;Please add the following DNS record: _EBCEA3AAA604EE544AFE2171A1C19D4A.decree-absolute.apply-divorce.service.gov.uk. 10800 IN CNAME 
CFBF67E5860E17571AFAFDC7492F6BA1.142AB2C674199D39D63BC25392096FBF.38b2baf94efabe47b94f.comodoca.com.&rdquo;</p>
</blockquote>
<p>Pointing the DNS is done in https://github.com/hmcts/azure-public-dns</p>
<p>With the example above, the address would belong in the &ldquo;apply-divorce-service-gov-uk.yml&rdquo; file.</p>
<p>These are some of the domains, but make sure you search the repo for the domain to find the one you are after:</p>
<p><a href="images/envfiles.png" rel="noopener noreferrer"><img src="/Certificates/images/envfiles.png" alt="" /></a>
<em>*Addresses which do not fall into any of these domains may be managed using a different service (eg legacy AWS dns zone).</em></p>
<p>The format for pointing the DNS, using the example described in the validation instructions above, is as follows:</p>
<div class="highlight"><pre class="highlight yaml" tabindex="0"><code> <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">_ebcea3aaa604ee544afe2171a1c19d4a.decree-absolute"</span>
   <span class="na">ttl</span><span class="pi">:</span> <span class="m">300</span>
   <span class="na">record</span><span class="pi">:</span> <span class="s2">"</span><span class="s">CFBF67E5860E17571AFAFDC7492F6BA1.142AB2C674199D39D63BC25392096FBF.38b2baf94efabe47b94f.comodoca.com."</span>
</code></pre></div><p>This is the DNS pointings when seen in the pull request:
<a href="images/pullrequest.png" rel="noopener noreferrer"><img src="/Certificates/images/pullrequest.png" alt="" /></a>
Broken down, the changes made to the validation instructions to achieve the correct format are:</p>
<p><strong>1. Add the name:</strong></p>

<ul>
<li>Remove <code>.apply-divorce.service.gov.uk</code>, since this is added automatically.
E.g:
<code>_EBCEA3AAA604EE544AFE2171A1C19D4A.decree-absolute.apply-divorce.service.gov.uk</code></li>
</ul>
<p><em>becomes</em></p>
<p>- name: <code>_ebcea3aaa604ee544afe2171a1c19d4a.decree-absolute</code></p>
<p><strong>2. Add a time to live</strong>
- any number would work, we use 300 seconds (5 minutes), e.g. <code>ttl: 300</code>.</p>
<p><strong>3. Add the record</strong></p>
<p>Remember to keep the full-stop at the end of the CNAME.
<code>CFBF67E5860E17571AFAFDC7492F6BA1.142AB2C674199D39D63BC25392096FBF.38b2baf94efabe47b94f.comodoca.com.</code></p>
<p>Becomes record: <code>CFBF67E5860E17571AFAFDC7492F6BA1.142AB2C674199D39D63BC25392096FBF.38b2baf94efabe47b94f.comodoca.com.</code></p>
<p>Once you have raised the PR and it has been approved and merged, you can check on the build on  <a href="https://dev.azure.com/hmcts/PlatformOperations/_build?definitionId=278">Azure DevOps</a>.</p>
<p>Prior to notifying Operations, check in <a href="https://mxtoolbox.com/">MXToolBox</a> that the DNS has been propagated successfully, this will prevent possible delays. Use the whole name of the record like so:
<a href="images/mxtools.png" rel="noopener noreferrer"><img src="/Certificates/images/mxtools.png" alt="" /></a>
Once the DNS has been pointed, reply to the operations team saying you&rsquo;ve added the DNS records. They will return the generated cert as an email attachment.</p>
<h3 id="step-3-upload-the-certificate-to-azure">Step 3: Upload the certificate to Azure</h3>

<ol>
<li><p>Download the email attachment
<a href="images/attachment.png" rel="noopener noreferrer"><img src="/Certificates/images/attachment.png" alt="" /></a></p></li>
<li><p><em>(Optional but recommended)</em> Create a new folder</p></li>
</ol>
<p>This is to keep your files organised and avoid confusion. Name it as you see fit, for example as below:
<a href="images/newfolder.png" rel="noopener noreferrer"><img src="/Certificates/images/newfolder.png" alt="" /></a></p>
<p>Copy and paste the relevant contents from the &lsquo;makepfx&rsquo; folder in <a href="https://github.com/hmcts/rdo-ssl-creation/tree/openssl-mac-branch">RDO-SSL-Creation</a>, into the newly created folder. The below files now exist in &lsquo;decree-absolute&rsquo;:</p>
<p><a href="images/makepfx.png" rel="noopener noreferrer"><img src="/Certificates/images/makepfx.png" alt="" /></a></p>
<p>In the terminal, change directory to the new folder in and place the downloaded cert from step 1 inside it.</p>

<ol>
<li><p>Convert the .txt file to a .p7b:</p></li>
<li><p>Go to Azure Key Vault → decree-absolute-apply-divorce-service-gov-uk → certificate operation → &lsquo;merge signed request&rsquo; and upload the p7b file.
<a href="images/keyvault.png" rel="noopener noreferrer"><img src="/Certificates/images/keyvault.png" alt="" /></a></p></li>
</ol>
<p>Once the merge is complete, you should see this:
<a href="images/complete.png" rel="noopener noreferrer"><img src="/Certificates/images/complete.png" alt="" /></a></p>
<p>:information_source:  At this point, the certificate is now renewed / procured.</p>
<p>The next steps are required only if the certificate is being placed in another vault in addition to infra-cert-prod. You can find out if required by either speaking to the dev who requested the cert or searching key vaults in Azure.</p>
<p>If you are renewing a certificate, it is common to check vaults such as, but not limited to, <code>cft-apps-prod</code> or <code>&lt;projectacronym&gt;-prod</code> for production certificates, <code>cftapps-dev</code> for development certificates, etc, and observing whether an old version of the renewed cert is there.</p>

<ol>
<li>Click into the current certificate version and download the pfx file by selecting &lsquo;Download in PFX/PEM format&rsquo;
<a href="images/downloadpfx.png" rel="noopener noreferrer"><img src="/Certificates/images/downloadpfx.png" alt="" /></a></li>
</ol>
<p><em><strong>Optional:</strong></em> Display private key.</p>
<p>If in case you are procuring a certificate for a developer in another project for example, they would require the private key as they may not have access to the key vault. To display the certificate&rsquo;s private key, run below command. At this point, there is no password, so just press enter when prompted for one.</p>

<blockquote>
<p>cat infra-cert-prod-decree-absolute-apply-divorce-service-gov-uk-20200609.pfx | openssl pkcs12 -nodes</p>
</blockquote>

<ol>
<li>Add a password to the cert:
Move the pfx file into the &lsquo;makepfx&rsquo; folder.
Run from the makepfx folder:</li>
</ol>

<blockquote>
<p>./pfxpassword.sh infra-cert-prod-decree-absolute-apply-divorce-service-gov-uk-20200609.pfx</p>
</blockquote>

<ol>
<li>Add the cert to the relevant key vault</li>
</ol>
<p>In this case, it&rsquo;s <strong>cft-apps-prod</strong>.</p>
<p>Go to the relevant cert (decree-absolute-apply-divorce-service-gov-uk) → new version → import → upload the cert.pfx file and type in the password.</p>
<p><em>*The password can be found in the &lsquo;pfxpassword.sh&rsquo; file in the &lsquo;makepfx&rsquo; folder.</em>
<a href="images/createcert.png" rel="noopener noreferrer"><img src="/Certificates/images/createcert.png" alt="" /></a></p>
<p>You should see this:
<a href="images/success.png" rel="noopener noreferrer"><img src="/Certificates/images/success.png" alt="" /></a></p>
<h3 id="shared-services-and-pet-certificates-only">* Shared Services and PET Certificates only *</h3>
<p>For some certs the process is slightly different, example certs include</p>

<ul>
<li>juror-bureau.justice.gov.uk</li>
<li>reply-jury-summons.service.gov.uk</li>
</ul>
<p>a) Download pfx of the renewed cert from the vault</p>
<p>b) Convert to base 64</p>

<blockquote>
<p>openssl base64 -in ~/Downloads/traefik-jb.pfx -out ~/Downloads/traefik-jdbase64.kl</p>
</blockquote>
<p>c) Reverse engineer and find new vault - e.g. shared service - <code>ss-vault-prod</code></p>
<p>d) Restart traefik pods so its picks up new certs</p>
<h4 id="common-errors-and-solutions">Common Errors and Solutions</h4>
<div class="table-container">
        <table>
          <tr>
<th>Error</th>
<th style="text-align: left">Solution</th>
</tr><tr>
<td>employment.service.gov.uk mxtool DNS check cannot find record</td>
<td style="text-align: left"><a href="images/commonerror.png" rel="noopener noreferrer"><img src="/Certificates/images/commonerror.png" alt=""></a></td>
</tr>
        </table>
      </div>