<h1 id="splunk-datadisk-configuration">Splunk datadisk configuration</h1>
<h2 id="overview">Overview</h2>
<p>The purpose of this documentation is to provide engineers with some additional details on how the data disk configuration has been setup in the splunk infrastructure, where the configuration of this can seem obscure to those who havent worked in this space before.</p>
<p>You can find all code related to the splunk infrastructure in the <a href="https://github.com/hmcts/soc">hmcts/soc</a> repository, the terraform for this lives side-by-side with Tenable nessus scanner and EventHub configurations.</p>
<p>Files related to the data-disk configuration:
- <a href="#mountfssh">mountfs.sh</a>
- <a href="#datadiskstf">datadisks.tf</a>
- <a href="#localtf">local.tf</a></p>
<h2 id="mountfs-sh">mountfs.sh</h2>
<p>The <a href="https://github.com/hmcts/soc/blob/master/components/splunk/mountfs.sh">mountfs.sh</a> script is used to format and mount data disks attached to splunk VMs to the /splunkdata and /splunkcolddata directories. The decision logic looks at the size of the datadisk attached to the VM and mounts it to the directories accordingly.</p>
<p>Notes:
- The script is executed as a Custom Script Extension.
- /splunkdata for disk sizes &lt; 1 TB, 2 TB or 15.6 TB in size.
- /splunkcolddata for disk sizes 3.9T or 12.7 TB.
- Sizes are read from fdisk command, this is incase the LUN numbers arent always consistent between the datadisks.
- Disk size has to match exactly that from fdisk in order for this to work.
- Disks are created within logical volume groups, so you could technically mount more than one disk a to given directory.
- If a disk is already matched and mounted to a directory, then the script will bypass doing anything (i.e. it wont modify any existing configurations).</p>
<h2 id="local-tf">local.tf</h2>
<p>The <a href="https://github.com/hmcts/soc/blob/master/components/splunk/local.tf">local.tf</a> file contains a number of objects related to the splunk data disk configurations.</p>
<p>Notes:
- Object &lsquo;vmdisks&rsquo; is where disks configurations should be placed, or referenced from the sbox.tfvars | prod.tfvars file.
- Object &lsquo;disk_list&rsquo; parases the vmdisks object into a map, such that it can be read by the terraform resource in datadisks.tf, without the need for complicated logic.</p>
<h2 id="datadisks-tf">datadisks.tf</h2>
<p>The file <a href="https://github.com/hmcts/soc/blob/master/components/splunk/datadisks.tf">datadisks.tf</a> contains the terraform resources for sorting data disk definitions and attachments applied to a VM.</p>
<p>Notes:
- The resources will read properties from &lsquo;local.disk_list&rsquo;.</p>
