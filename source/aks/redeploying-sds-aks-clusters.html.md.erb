---
title: Redeploying and Upgrading SDS AKS Clusters Runbook
weight: 30
---

# <%= current_page.data.title %>

This wiki page documents some tasks that we have to perform when deploying or upgrading any of the SDS AKS Clusters

## To create a cluster:

When redeploying, delete the cluster manually in portal. You will have to remove the lock on resource group if applied.

Go to the [pipeline](https://dev.azure.com/hmcts/PlatformOperations/_build?definitionId=482). 

Click on **Run pipeline** (blue button) in top right of Azure DevOps. Ensure that Action is set to Apply, Cluster is set to which ever one you want to build and that the environment is selected from the drop down menu. 

Click on **Run** to start the pipeline.

## Deployment Order

This order can change; created to give a brief overview of the environments.

Redeploying in order:-

- Sbox             - (K8s service names are  = ss-sbox-00-aks - ss-sbox-01-aks)
- Management Sbox/ Ptlsbox  - (K8s service name is    = ss-ptlsbox-00-aks)
- ITHC             - (K8s service names are  = ss-ithc-00-aks - ss-ithc-01-aks)
- DEV              - (K8s service names is   = ss-dev-01-aks)
- Preview          - (K8s service name is    = ss-preview-01-aks)
- Perftest         - (K8s service names are  = ss-test-00-aks - ss-test-01-aks)
- Demo             - (K8s service names are  = ss-demo-00-aks - ss-demo-01-aks)
- AAT              - (K8s service names are  = ss-stg-00-aks - ss-stg-01-aks)
- Production       - (K8s service names are  = ss-prod-00-aks - ss-prod-01-aks) 
- Management/ Ptl       - (K8s service name is    = ss-ptl-00-aks) 

## Dashboards - LINKS NEED UPDATING
A good indication along with reviewing the environments themselves, reviewing Grafana
[Grafana Sandbox](https://grafana.sandbox.platform.hmcts.net/)
[Grafana](https://grafana-ptl.platform.hmcts.net/)

##  Environment specifics
Some environments do have some additional requirements/checks that need to confirmed prior to deploying any of its clusters.

Upgrading AKS Clusters

## Pods and HRs Health Checks
Before upgrading any of the clusters run the following query on the cluster you are planning to upgrade to find out the statuses of the pods and hrs
```
{
kubectl get pods -A | wc -l > pods_total_count && kubectl get pods -A > pods_all_status && kubectl get pods -A | awk '!/(Running|Succeeded)/' > pods_not_running_or_succeeded && kubectl get hr -A > hr_all_status
}
```
Three files will be saved in the directory from within you have run the above command.

##  Environment specifics
Some environments do have some additional requirements/checks that need to confirmed prior to deploying any of its clusters.

# Sandbox
#### Before deployment of a cluster
- Remove the cluster you are going to redeploying from the AGW. [PR example here](https://github.com/hmcts/sds-azure-platform/pull/473/files)
- Unsure which IP belongs to which cluster? Check the front end IP of the kubernetes-internal loadbalancer

#### After deployment of a cluster
- Add the cluster back into AGW once you have confirmed deployment has been successful. [PR example here](https://github.com/hmcts/sds-azure-platform/pull/474/files)

# Management Sandbox
N/A

# Demo
#### Before deployment of a cluster
- Remove the cluster you are going to redeploying from the AGW. [PR example here](https://github.com/hmcts/sds-azure-platform/pull/473/files)
- Unsure which IP belongs to which cluster? Check the front end IP of the kubernetes-internal loadbalancer

#### After deployment of a cluster
- Add the cluster back into AGW once you have confirmed deployment has been successful. [PR example here](https://github.com/hmcts/sds-azure-platform/pull/474/files)

# ITHC, DEV, Perftest, AAT
#### Before deployment of a cluster
- Remove the cluster you are going to redeploying from the AGW. [PR example here](https://github.com/hmcts/sds-azure-platform/pull/473/files)
- Unsure which IP belongs to which cluster? Check the front end IP of the kubernetes-internal loadbalancer
- Change Jenkins to use the other cluster that is not going to be redeployed, e.g. [PR example here](https://github.com/hmcts/sds-flux-config/pull/2637/files) .
  - If not updated, you can change manually providing PR has been approved and merged [View Jenkins Configuration](https://build.platform.hmcts.net/configure)

#### After deployment of a cluster
- Add the cluster back into AGW once you have confirmed deployment has been successful. [PR example here](https://github.com/hmcts/sds-azure-platform/pull/474/files)
- Update Civil DNS entries to point to the active Jenkins cluster (until they switch to using platform-hmcts-net). [Update active jenkins-cluster IP value in DNS](https://github.com/hmcts/azure-private-dns/pull/428/files) and [update existing platform-hmcts-net entries](https://github.com/hmcts/sds-flux-config/pull/2631/files).

# Upgrade Cluster
Put a message out into the  #cloud-native-announce channel to notify people which cluster will be upgraded
Find the cluster you want to upgrade into the portal > Cluster Configuration > Upgrade Version > in the Kubernetes version drop down menu choose the latest GA version > Click Save
This will trigger the upgrade of the cluster, which will take some time. Once this has finished you need to create a PR in this [repo](https://github.com/hmcts/aks-sds-deploy/blob/master/environments/aks/ptlsbox.tfvars#L3) changing the kubernetes_version value
 * Note: The kubernetes_version value only takes major version values, i.e 1.25, 1.26 and so on.
Once the changes have been reviewed, approved and merged, the [Pipeline](https://dev.azure.com/hmcts/PlatformOperations/_build?definitionId=482) will run. Once completed compare the hrs and pods statuses with the ones you saved for the upgrade took place.