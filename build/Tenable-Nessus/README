<h1 id="tenable-nessus">Tenable Nessus</h1>
<p>Tenable Nessus is a proprietary vulnerability scanner developed by Tenable. The scanner allows the security team
to scan devices and check them against the nessus database that contains thousands of known vulnerabilities
and patch them before they are exploited. There are three components to the tenable setup, the server, scanners
and the agents. This runbook will cover the following
- Tenable anvironments 
- Deploying agents
- Verifiying agent installation.</p>
<p>This runbook does not cover the finer details of the Terraform bootstrap module.</p>
<h2 id="environments">Environments</h2>
<p>There are three environments, Prod, Non-Prod and Sbox, the non-prod VM scalesets reside within the prod 
resource group.</p>
<h3 id="production-and-non-production">Production and Non-Production</h3>
<p><b>Subscription:</b> HMCTS-SOC-PROD</p>
<p><b>Resource Group:</b> soc-tenable-prod-rg</p>
<p><b>server:</b> tenable-sc-prod-vm00</p>
<p><b>VM ScaleSets:</b> nessus-scanners-prod / nessus-scanners-nonprod</p>
<h3 id="sbox">Sbox</h3>
<p><b>Subscription:</b> soc-tenable-sbox-rg</p>
<p><b>Resource Group:</b> HMCTS-SOC-SBOX</p>
<p><b>server:</b> tenable-sc-sbox-vm00</p>
<p><b>VM ScaleSets:</b> nessus-scanners-sbox</p>
<h2 id="deploying-agents">Deploying Agents</h2>
<p>The agent is deployed using terraform bootstrap module  <a href="https://github.com/hmcts/terraform-module-vm-bootstrap">terraform-module-vm-bootstrap</a>. The module is designed to install to Linux and Windows machines.</p>

<blockquote>
<p>The example given below is specific to the Heritage environemnt.</p>
</blockquote>
<h4 id="steps-to-setup-deployment">Steps to setup deployment:</h4>

<ul>
<li>Call the terraform-bootstrap-module from the <a href="https://github.com/hmcts/oracle-azure-infrastructure-terraform-modules">oracle-azure-infrastructure-terraform-modules</a> , a working sample code has been provided below </li>
</ul>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>module "vm-bootstrap" {
  count  = var.install_splunk_uf == true || var.nessus_install == true ? var.vm_count : 0
  source = "git::https://github.com/hmcts/terraform-module-vm-bootstrap.git?ref=master"

  virtual_machine_type         = "vm"
  virtual_machine_id           = azurerm_virtual_machine.general_purpose_vm[count.index].id
  os_type                      = local.os_type
  nessus_server                = var.nessus_server
  nessus_key                   = var.nessus_key
  nessus_groups                = var.nessus_groups
  install_dynatrace_oneagent   = false
  install_azure_monitor        = false
}
</code></pre></div>
<ul>
<li>Add all the required variables </li>
</ul>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>variable "nessus_install" {
default = false
}

variable "nessus_server" {}

variable "nessus_key_name" {
default = null
}

variable "nessus_groups" {
default = null
}

data "azurerm_key_vault_secret" "nessus_key" {
count    = var.nessus_install ? 1 : 0
provider = azurerm.soc

name         = var.nessus_key_name
key_vault_id = data.azurerm_key_vault.soc_vault[0].id
}
</code></pre></div>
<ul>
<li>Run associated Heritage VM <a href="https://dev.azure.com/hmcts/PlatformOperations/_build?definitionId=433">pipeline</a> on Azure DevOps</li>
</ul>
<h2 id="verifying-agent-installation">Verifying Agent Installation</h2>
<p>After deployment of the Nessus agent, it will register with the Nessus Manager host inside to the appropriate agent group.</p>

<blockquote>
<p>Permissions for PlatOps to access the Nessus Manager is currently being setup by SecOps; until access is enabled, they will confirm the node in the console to validate agent installation and 
configuration, please contact Ian Knight from SecOps to verify that the agent can be seen on the Tenable Server.</p>
</blockquote>
<h4 id="connect-to-the-tenable-server">Connect to the Tenable Server</h4>

<ul>
<li>Ensure you have JIT access and you are connected to the VPN </li>
<li>Get the SSH config from Azure (valid for 1 hour)
<code>
az ssh config --resource-group bastion-prod-rg --vm-name bastion-prod --prefer-private-ip --file ./sshconfig Paste into ~/.ssh/config
</code></li>
<li>Start port-forwading/SSH tunnel to Nessus host. To port forward to the Tenable Server, run the following command replacing the variable with the intended IP. </li>
</ul>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>ssh -L 5000:&lt;VM-PRIVATE-IP&gt;:8834 bastion-prod-rg-bastion-prod
</code></pre></div>
<ul>
<li>Go to browser https://localhost:5000</li>
</ul>
<h2 id="troubleshooting-agents">Troubleshooting Agents</h2>
<h3 id="prerequisites">Prerequisites</h3>

<ul>
<li>Enable JIT access to non-prod or Production Bastion, you can do that <a href="https://myaccess.microsoft.com/">here</a>.</li>
<li>Connect to <a href="https://portal.platform.hmcts.net">F5</a>.</li>
</ul>
<h3 id="linux-agents">Linux Agents</h3>
<p>Check if the agent has deployed correctly 
<code>
systemctl status 
</code></p>
<p>Remove agent from server 
<code>
rpm -qa | grep -i NessusAgent
</code>
<code>
rpm -e NessusAgent-10.1.3-es7.x86_64
</code></p>
<h3 id="windows-agents">Windows Agents</h3>
<p>Commands to check Machine connectivity
<code>
tnc nessus-scanners-nonprod000005.platform.hmcts.net
</code></p>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>tnc -port 8834 nessus-scanners-nonprod000005.platform.hmcts.net
</code></pre></div><p>Nessus Link commands</p>
<p>Open CMD</p>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>Cd into  c:\programdata\nesses agent\nessuscli.exe
</code></pre></div><p>Check if the agent is linked to a scanner with the command below</p>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>nessuscli agent status
</code></pre></div><p>You should see a response similar to output below</p>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>C:\Program Files\Tenable\Nessus Agent&gt;nessuscli agent status
Running: Yes
Linked to: nessus-scanners-nonprod000005.platform.hmcts.net:8834
Link status: Connected to nessus-scanners-nonprod000005.platform.hmcts.net:8834
Last successful connection with controller: 10 secs ago
Proxy: None
Plugin set: (null)
Scanning: No (0 jobs pending, 0 smart scan configs)
Scans run today: 0 of 10 limit
Last scanned: Never
Last connect: 1655998378
Last connection attempt: 1655998378
</code></pre></div><h2 id="important-links">Important links</h2>

<ul>
<li><p>https://docs.tenable.com/nessus/Content/NessusCLIAgent.htm#Nessuscli-Commands</p></li>
<li><p>https://docs.tenable.com/nessus/Content/RemoveNessusAgentLinux.htm</p></li>
</ul>
