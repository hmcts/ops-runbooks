---
title: How to support the use of CME 213 Phase 1 tool
last_reviewed_on: 2026-01-07
review_in: 12 months
weight: 25
---

# <%= current_page.data.title %>

This provides instructions on how to support a reindex using the CME 213 Phase 1 method.

This will be made as generic as possible with places to enter the values needed.

A change request should be raised for production, which will be scheduled for out of hours. As part of the change get confirmation of case_type_id and the name of the index.
[Example implementation plan](https://tools.hmcts.net/confluence/display/RSTR/NDL-1.1.0+-+Amend+Elastic+Search+Index+Configuration+Release+Implementation+Plan)

Example index name: `nfd_cases-000001`
Example case_type_id: `NFD`

Some changes will include both non-production and production environments. 

1) Request JIT access for the relevant environments bastion. (https://myaccess.microsoft.com/)

2) Make sure you are connected to the F5 VPN

3) Connect to the bastion server

```
az ssh config --ip \*.platform.hmcts.net --file ~/.ssh/config
```

Non-prod:
```
ssh bastion-nonprod.platform.hmcts.net
```

Prod:
```
ssh bastion-prod.platform.hmcts.net
```

4) Find the IP address for the service you wish to connect to and connect to Elastic Search node:
For a list of IP addresses for each env, go to:

[DEMO](https://portal.azure.com/#@HMCTS.NET/resource/subscriptions/1c4f0704-a29e-403d-b719-b90c34ef14c9/resourceGroups/ccd-elastic-search-demo/providers/Microsoft.Network/networkSecurityGroups/ccd-cluster-nsg/networkInterfaces)

[PERFTEST](https://portal.azure.com/#@HMCTS.NET/resource/subscriptions/7a4e3bd5-ae3a-4d0c-b441-2188fee3ff1c/resourceGroups/ccd-elastic-search-perftest/providers/Microsoft.Network/networkSecurityGroups/ccd-cluster-nsg/networkInterfaces)

[AAT](https://portal.azure.com/#@HMCTS.NET/resource/subscriptions/1c4f0704-a29e-403d-b719-b90c34ef14c9/resourceGroups/ccd-elastic-search-aat/providers/Microsoft.Network/networkSecurityGroups/ccd-cluster-nsg/networkInterfaces)

[Production](https://portal.azure.com/#@HMCTS.NET/resource/subscriptions/8999dec3-0104-4a27-94ee-6588559729d1/resourceGroups/ccd-elastic-search-prod/providers/Microsoft.Network/networkSecurityGroups/ccd-cluster-nsg/networkInterfaces)

Connect to Elastic Search node from relevant bastion:
```
ssh -p22  elkadmin@<ip address> -i <logstash ssh key>
```

5) 	Stop the logstash instance that the team uses, this is to avoid any issues from scheduled jobs

Most teams do not have dedicated instances but some do.

You can scale the instance down to 0 to stop it running in this [repo](https://github.com/hmcts/cnp-flux-config) in the event the team has a dedicated instance.

In the event that the team does not have a dedicated instance they can be removed from the logstash query to ensure none of their data is processed during the reindex, Update this [file]()

Running this command on the relevant AKS cluster will let you see all logstash instances which can be scaled up and down in the cnp-flux-config repo.

```
kubectl get pods -A |grep logstash
```

6) Check overall DB count prior to running the tool

Connect to ccd-data-store DB from Bastion server and run this query:

```
SELECT count(*) FROM case_data WHERE case_type_id = '<your case type id>';
```

7) Ensure there are no cases currently waiting to be picked up by logstash

This command will return a count for all teams with unmarked cases. 
```
select case_type_id, jurisdiction, count(*) from case_data cd where marked_by_logstash = 'false' group by cd.case_type_id, jurisdiction order by jurisdiction asc, case_type_id asc;
```
The following commands can be changed to target specific case_type_id or jurisdiction if needed.

```
select case_type_id, jurisdiction, count(*) from case_data cd where marked_by_logstash = 'false' and jurisdiction = 'Your_Jusrisdiction_Here' group by cd.case_type_id, jurisdiction order by jurisdiction asc, case_type_id asc;
```

```
select case_type_id, jurisdiction, count(*) from case_data cd where marked_by_logstash = 'false' and case_type_id = 'Your_Case_Type_ID_Here' group by cd.case_type_id, jurisdiction order by jurisdiction asc, case_type_id asc;
```

Any of these commands should return 0 results for the case_type_id or jurisdiction you are reindexing.

8) Check the index count prior to running the tool

Run the below command on the Elastic search VM to get the current index count.

```
curl --silent localhost:9200/_cat/indices | awk '{print $3, $7}' | grep <Your index name>
```

9) Block writing to main index ahead of cloning

```
curl -X PUT "localhost:9200/<Your index name>/_settings?pretty" -H 'Content-Type: application/json' -d' {"settings": {"index.blocks.write": true}}'
```

10) Clone the index for backup incase of rollback

Make sure this clones name ends in the same number as the index you are cloning.

```
curl -X POST "localhost:9200/<Your index name>/_clone/cloned-<Your index name>?pretty"
```

After this command, please check both indexes exist by running the command from step 7 again.

11) Inform the service team to start the CME 213 Phase 1 tool

The service team will need to run the CME 213 Phase 1 tool to start the reindexing process.

This tool should upload a new definition file which creates a new index with the +1 to the index name.
It will retain the original index as a backup.

Once the tool is complete it should have used the reindexing API to copy the data from the original index to the new index along with assigning the alias to the new index.


12) Check the reindexing tool was successful

Once the service team has confirmed that the CME 213 Phase 1 tool has finished running check the index count to ensure it matches the original, the new index will be created with a +1 to the index name. 
For example if the original index was `nfd_cases-000001` the new index will be `nfd_cases-000002`.

```
curl --silent localhost:9200/_cat/indices | awk '{print $3, $7}' | grep <Your index name>
```

If the index count isnt up to what is expected but no error was shown in step 17, then please run the below command and check again.

```
curl -X GET "localhost:9200/_refresh?pretty"
```

13) Ensure you revert the logstash instance changes made in step 5

### Post Implementation steps

A few days after the reindex has been completed and verified by the service team to have no issues, please follow these steps to clean up.

1) Check for all indexes

```
curl --silent localhost:9200/_cat/indices | awk '{print $3, $7}' | grep <Your index name>
```

2) Delete the original index which was kept as a backup during the reindexing process.

Please run the below command to delete the original index. 

```
curl -X DELETE localhost:9200/<your original index name>;
```


### Rollback steps

If after running the tool issues are noticed the following steps should be followed:

1) Set the index alias of our original index

Check with service team what the alias should be if unsure.

```
curl -X POST "localhost:9200/_aliases?pretty" -H 'Content-Type: application/json' -d' { "actions": [ { "add": { "index": "<your index name>", "alias": "<your index alias>" } } ] } '
```

Run this command to verify the alias has been set correctly

```
curl -X GET "localhost:9200/_alias/<your index alias>?pretty"
```

2) Delete the new index that was created as part of the re index

```
curl -X DELETE localhost:9200/<Your new index name>;
```

3) Service teams to verify if the rollback has been successful