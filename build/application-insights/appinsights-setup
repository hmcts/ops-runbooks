<h1 id="setting-up-application-insights-reporting">Setting Up Application Insights Reporting</h1>
<p>This document covers how to set up AppInsights reporting on your app. These instructions assume you already have an AppInsights resource configured and set up. Your application will need access to the Connection String for this AppInsights resource. This Connection String can be found in the &lsquo;Overview&rsquo; section when viewing the resource in the Azure Portal. Although the value is not obfuscated in the portal, it should still be treated as sensitive and it should be provided to your application as if it were a secret. The methods for doing this are language specific and beyond the scope of this document.</p>
<p>To set up AppInsights, Specific instructions for your language can be found below:</p>

<ul>
<li><a href="#nodejs-apps">Node.JS Apps</a></li>
</ul>
<h2 id="node-js-apps">Node.JS Apps</h2>
<p>Microsoft provide three NPM packages for Node.JS applications: <code>applicationinsights</code>, <code>applicationinsights-js</code> and <code>@microsoft/applicationinsights-web</code>. For our purposes, we want <strong>ONLY</strong> the <code>applicationinsights</code> package. <code>applicationinsights-js</code> is considered deprecated and <code>@microsoft/applicationinsights-web</code> is designed for frontend applications only. Installing either of these other two options in our case may be detrimental and actually cause AppInsights to stop working.</p>
<p>Start by installing the <code>applicationinsights</code> package to your project:</p>
<div class="highlight"><pre class="highlight shell" tabindex="0"><code>npm <span class="nt">-i</span> applicationinsights
</code></pre></div><p>Next, preferably near the top of your app, we need to <code>require</code> the library:</p>
<div class="highlight"><pre class="highlight javascript" tabindex="0"><code><span class="kd">let</span> <span class="nx">appInsights</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">applicationinsights</span><span class="dl">'</span><span class="p">);</span>
</code></pre></div><p>Next, we can finally set up AppInsights using the following snippet. You&rsquo;ll need to substitute the connection string for your AppInsights resource here.</p>
<p><strong>The default configuration snippet provided in the Microsoft Docs for this package does not work. Use this instead.</strong></p>
<div class="highlight"><pre class="highlight javascript" tabindex="0"><code><span class="nx">appInsights</span><span class="p">.</span><span class="nx">setup</span><span class="p">(</span><span class="dl">'</span><span class="s1">&lt;your connection string here&gt;</span><span class="dl">'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">setAutoDependencyCorrelation</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">setAutoCollectRequests</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">setAutoCollectPerformance</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">setAutoCollectExceptions</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">setAutoCollectDependencies</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">setAutoCollectConsole</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">setUseDiskRetryCaching</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">setSendLiveMetrics</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">setDistributedTracingMode</span><span class="p">(</span><span class="nx">appInsights</span><span class="p">.</span><span class="nx">DistributedTracingModes</span><span class="p">.</span><span class="nx">AI</span><span class="p">);</span>
<span class="nx">appInsights</span><span class="p">.</span><span class="nx">defaultClient</span><span class="p">.</span><span class="nx">context</span><span class="p">.</span><span class="nx">tags</span><span class="p">[</span><span class="nx">appInsights</span><span class="p">.</span><span class="nx">defaultClient</span><span class="p">.</span><span class="nx">context</span><span class="p">.</span><span class="nx">keys</span><span class="p">.</span><span class="nx">cloudRole</span><span class="p">]</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">&lt;your application name&gt;</span><span class="dl">'</span><span class="p">;</span>
<span class="nx">appInsights</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>
</code></pre></div><p>Exactly what all these values mean and do is explained in the <a href="https://docs.microsoft.com/en-us/azure/azure-monitor/app/nodejs#advanced-configuration-options">Microsoft Docs for this package</a>. These values have been more-or-less kept to their defaults, with the exception of <code>.setAutoCollectConsole(true, true)</code>, this has been changed to report any message sent to the console via <code>console.log(...)</code> or similar. Feel free to adjust these values to your needs. Note that this snippet will also set the &lsquo;cloudRole&rsquo; tag to whatever your application is called (e.g. &lsquo;slack-help-bot&rsquo;, &lsquo;idam-frontend&rsquo;, etc.). This will show up in the &lsquo;cloud_RoleName&rsquo; field when exploring the trace viewer in the Azure Portal and can be used to filter traces for those sent by your application.</p>
<p>To verify that AppInsights reporting is working correctly, you can send a trace message directly to AppInsights with the following line in your app and then check it appears in the Azure Portal. Note that it can take several minutes for a message to appear in AppInsights once it is sent.</p>
<div class="highlight"><pre class="highlight javascript" tabindex="0"><code><span class="nx">appInsights</span><span class="p">.</span><span class="nx">defaultClient</span><span class="p">.</span><span class="nx">trackTrace</span><span class="p">({</span><span class="na">message</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Is AppInsights working?</span><span class="dl">"</span><span class="p">});</span>
</code></pre></div>