<h1 id="troubleshooting">Troubleshooting</h1>
<p>Examples of common errors you may face when having to work on the Palos</p>
<h2 id="problem-not-able-to-connect-to-ansible-host">Problem - Not able to connect to ansible host</h2>
<h3 id="example-error"><strong>Example error</strong></h3>
<div class="highlight"><pre class="highlight shell" tabindex="0"><code><span class="c">##[error]Terraform command 'apply' failed with exit code '1'.:  timeout - last error: dial tcp 51.137.145.88:22: i/o timeout</span>
</code></pre></div><h3 id="troubleshooting-tip"><strong>Troubleshooting tip</strong></h3>
<p>This is most likely down to retrying steps in the pipeline.
Each run a firewall rule is added to allow the Azure DevOps agent to connect to the ansible agent and at the end of the pipeline it is removed, so when you re-run failed steps in the pipeline you are not adding that rule back in, therefore the agent is unable to connect and you get the above error.</p>
<h2 id="problem-ansible-has-failed-to-apply-the-palo-configuration">Problem - Ansible has failed to apply the palo configuration</h2>
<p>This error is usually caused by the Palo&rsquo;s XML config not applying due to malformed xml or incorrect references to objects etc.</p>
<h3 id="problem-ansible-has-failed-to-apply-the-palo-configuration-example-error"><strong>Example error</strong></h3>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>module.hub-infra.module.firewall.null_resource.ansible-runs (remote-exec): fatal: [51.11.xxx.xxx]: FAILED! =&gt; {
...
...
...
module.hub-infra.module.firewall.null_resource.ansible-runs (remote-exec):     "msg": "Failed commit: Commit failed"
module.hub-infra.module.firewall.null_resource.ansible-runs (remote-exec): }
</code></pre></div><h3 id="problem-ansible-has-failed-to-apply-the-palo-configuration-troubleshooting-tip"><strong>Troubleshooting tip</strong></h3>

<ol>
<li><p>Follow the steps in <a href="connecting.md">the connecting guide</a> and log into one of the Palos in the environment where your changes are failing to apply.</p></li>
<li><p>Once you&rsquo;re logged in you will see a commit button in the top right-hand side of your screen like below:
<details> 
<summary>Commit Button</summary></p>
<p><a href="images/palo-commit.png" rel="noopener noreferrer"><img src="/network/palos/images/palo-commit.png" alt="Commit Button" /></a></p>
<p></details></p></li>
<li><p>A dialog box will pop up giving you the option to validate the most recent configuration, click on validate commit.</p>

<details> 
<summary>Validate Button</summary>

![Validate Button](images/validate-button.png)

</details></li>
<li><p>This will run for a few seconds, once it&rsquo;s complete you&rsquo;ll be presented with a status page giving you a clearer idea of what the problem is.</p></li>
</ol>
<p>In this case we can see that the configuration is in fact invalid. 
The errors tell us that the <code>log-setting</code> value <code>azure_log_analytics_out</code> is incorrect, after looking through the code the <code>azure_log_analytics_out</code> log setting is a nonprod setting that isn&rsquo;t available in Production and just removing the line fixed the issue.</p>

<details> 
    
<summary>Validate Example</summary>
    
![Validate Example](images/example-validate.png)
    
</details>

<ol>
<li>Make your changes in the rdo-terraform-hub-dmz repository and run the <a href="https://dev.azure.com/hmcts/PlatformOperations/_build?definitionId=226&amp;_a=summary">pipeline</a> again.</li>
</ol>
<h2 id="problem-debugging-connectivity-issues">Problem - debugging connectivity issues</h2>
<p>You may come across issues with connections being dropped and need to investigate where and why its happening.</p>
<h3 id="problem-debugging-connectivity-issues-troubleshooting-tip"><strong>Troubleshooting tip</strong></h3>
<p>The Palos have a built in traffic monitoring tool that could help you find the issue and tell you what the reason is for the drop.</p>

<ol>
<li>Log into both of the Palo Alto&rsquo;s for the environment</li>
<li>Click on the monitoring tab at the top of the page</li>
<li>Start with the <code>( action eq deny )</code> filtering rule to view connections being dropped by the Palo.</li>
<li>Add any extra filters such as <code>(addr.src in a.a.a.a)</code> or <code>(addr.dst in b.b.b.b)</code> to help filter out logs you don&rsquo;t need to see.</li>
<li>Make sure you check both Palo Alto&rsquo;s as there&rsquo;s a load balancer in front, traffic could go to either or both.</li>
</ol>

<details>

<summary>Filtering Example</summary>

<img alt="Traffic Filtering" src="images/filtering.png" width="300" height="200">

</details>
<p>For more information on types of filters you can apply check out <a href="https://knowledgebase.paloaltonetworks.com/KCSArticleDetail?id=kA10g000000ClSlCAK">Basics of traffic monitor filtering</a>.</p>
