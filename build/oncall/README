<h1 id="on-call">On call</h1>
<p>This folder describes access requirements and how to do common tasks when a person is on-call.</p>
<p>It is required that you go through this document before going on-call, and verify you have access to all components.</p>
<h2 id="azure-active-directory-groups">Azure Active Directory Groups</h2>
<p>You must be in the following groups:</p>

<ul>
<li>DTS Platform Operations</li>
</ul>
<p>You can add yourself via the <a href="https://github.com/hmcts/devops-azure-ad/blob/master/users/prod_users.yml">devops-azure-aad GitHub repo</a>.</p>
<h2 id="connecting-to-services">Connecting to services</h2>
<p>Before you go on call you need to make sure you have access to each service</p>
<h3 id="cft-kubernetes">CFT Kubernetes</h3>
<p>CFT has two prod kubernetes clusters, the current login command is:</p>
<div class="highlight"><pre class="highlight shell" tabindex="0"><code>az login
az aks get-credentials <span class="nt">--resource-group</span> cft-prod-00-rg <span class="nt">--name</span> cft-prod-00-aks <span class="nt">--subscription</span> DCD-CFTAPPS-PROD <span class="nt">--overwrite</span>
az aks get-credentials <span class="nt">--resource-group</span> cft-prod-01-rg <span class="nt">--name</span> cft-prod-01-aks <span class="nt">--subscription</span> DCD-CFTAPPS-PROD <span class="nt">--overwrite</span>

kubectl get pods <span class="nt">-n</span> admin
<span class="c"># this will prompt you to login via Azure Active Directory</span>
<span class="c"># after your login verify you can restart a pod, e.g. fluxcloud (admin notifying service, downtime doesn't matter)</span>
kubectl delete pod <span class="nt">-n</span> admin <span class="nt">-l</span> <span class="nv">app</span><span class="o">=</span>fluxcloud
</code></pre></div><p>The default configuration for an application is two pods on each cluster, but teams may have more.</p>
<h3 id="idam-access">IDAM access</h3>
<p>Idam is accessed via a bastion server of its own, also known as the idam jump box. Follow the below steps for access via the production bastion server.</p>

<ol>
<li>Request time based access (Automatically approved)</li>
</ol>
<p>Navigate to https://myaccess.microsoft.com/
* Select: Production Bastion Server Access followed by &ldquo;+ Request Access&rdquo;
* Select: On-Call policy, no business justification is required.
* Request: For specific period: Enter the period you are on-call for.
* Submit (A green notification will confirm this was successful).</p>

<ol>
<li>Download <code>devops-sshkey-privatekey</code> and set permissions
<code>bash
az keyvault secret download -f ~/.ssh/cft-idam --vault-name idamvaultprod --name devops-ssh-privatekey
chmod 600 ~/.ssh/cft-idam
</code></li>
<li>Retrieve passphrase for IDAM SSH key and add RSA identity. 
<code>bash
az keyvault secret show --vault-name idamvaultprod --name devops-sshkey-passphrase --query value -o tsv
ssh-add ~/.ssh/cft-idam # paste the output of the previous command for the passphrase
</code></li>
<li>Open the <code>~/.ssh/config</code> file (create if it doesn&rsquo;t already exist) and add the below:</li>
</ol>
<p><strong>Add your own username to line 3</strong>
&ldquo;`bash</p>
<h1 id="bastion-devops-production-access">Bastion - DevOps production access</h1>
<p>Host prodbastion
HostName bastion-prod.platform.hmcts.net
User {AD USERNAME HERE}@hmcts.net # this must be all in lowercase.
DynamicForward 10825
ForwardAgent yes
KeepAlive yes
ServerAliveInterval 60
&rdquo;`
5. Connect to HMCTS <a href="https://portal.platform.hmcts.net/">VPN</a></p>
<p>Connect with:
<code>bash
ssh prodbastion
</code></p>
<p>Follow the on-screen instructions to authenticate with yout HMCTS credentials.</p>

<ol>
<li>Connect to IDAM Jump server
<code>bash
ssh devops@idam-bastion.platform.hmcts.net
</code></li>
</ol>
<p><strong>Note:</strong> In the event of an emergency, you can bypass the first bastion server from Step 5 by adding your home IP address to the NSG <a href="https://portal.azure.com/#@HMCTS.NET/resource/subscriptions/8999dec3-0104-4a27-94ee-6588559729d1/resourceGroups/core-infra-idam-prod2/providers/Microsoft.Network/networkSecurityGroups/core-infra-idam-prod2-jumpbox-nsg/inboundSecurityRules">core-infra-idam-prod2-jumpbox-nsg</a>. You will find the public IP attached to idam-prod2-jumpbox VM in Azure.</p>
<p><strong>Note:</strong> there is a DNS name idam-bastion.platform.hmcts.net, but some people have had issues connecting using it. Local IP is: <code>10.106.79.4</code>.</p>
<p>The <a href="https://github.com/hmcts/idam-tools">idam-tools</a> repository is checked out in the home directory of the <code>devops</code> user.
There&rsquo;s useful scripts there.</p>
<p>You can also jump from this server to the other ones, you will need to provide the SSH key passphrase each time you log in.</p>
<div class="highlight"><pre class="highlight plaintext" tabindex="0"><code>ssh idam@forgerock-idm-1
ssh idam@forgerock-idm-2
ssh idam@forgerock-idm-3
</code></pre></div>